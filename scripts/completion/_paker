#compdef paker Paker
# Paker Zsh æ™ºèƒ½è¡¥å…¨è„šæœ¬
# æ”¯æŒåŠ¨æ€è¡¥å…¨ã€ä¸Šä¸‹æ–‡æ„ŸçŸ¥ã€æ™ºèƒ½å»ºè®®

# è¡¥å…¨å‡½æ•°
_paker() {
    local context state line
    local -a commands subcommands flags
    
    # ä¸»å‘½ä»¤åˆ—è¡¨
    commands=(
        'init:åˆå§‹åŒ–é¡¹ç›®'
        'add:æ·»åŠ ä¾èµ–åŒ…'
        'remove:ç§»é™¤ä¾èµ–åŒ…'
        'list:åˆ—å‡ºæ‰€æœ‰ä¾èµ–'
        'tree:æ˜¾ç¤ºä¾èµ–æ ‘'
        'search:æœç´¢ä¾èµ–åŒ…'
        'info:æŸ¥çœ‹åŒ…ä¿¡æ¯'
        'update:åŒæ­¥æœ¬åœ°ä¾èµ–'
        'upgrade:å‡çº§æ‰€æœ‰ä¾èµ–'
        'lock:é”å®šä¾èµ–ç‰ˆæœ¬'
        'install-l:æŒ‰é”æ–‡ä»¶å®‰è£…'
        'resolve:è§£æé¡¹ç›®ä¾èµ–'
        'check:æ£€æŸ¥ä¾èµ–å†²çª'
        'fix:è§£å†³ä¾èµ–å†²çª'
        'validate:éªŒè¯ä¾èµ–å®Œæ•´æ€§'
        'perf:ç”Ÿæˆæ€§èƒ½æŠ¥å‘Š'
        'analyze:åˆ†æä¾èµ–ç»“æ„'
        'diagnose:è¿è¡Œç³»ç»Ÿè¯Šæ–­'
        'monitor-enable:å¯ç”¨æ€§èƒ½ç›‘æ§'
        'monitor-clear:æ¸…é™¤ç›‘æ§æ•°æ®'
        'cache:ç¼“å­˜ç®¡ç†'
        'rollback:å›æ»šç®¡ç†'
        'history:ç‰ˆæœ¬å†å²ç®¡ç†'
        'record:åŒ…å®‰è£…è®°å½•'
        'parse:å¢é‡è§£æç®¡ç†'
        'io:å¼‚æ­¥I/Oç®¡ç†'
        'warmup:ç¼“å­˜é¢„çƒ­'
        'remote-add:æ·»åŠ ä¾èµ–æº'
        'remote-rm:ç§»é™¤ä¾èµ–æº'
        'version:æ˜¾ç¤ºç‰ˆæœ¬ä¿¡æ¯'
        'remove-project:ç§»é™¤é¡¹ç›®'
        'suggestion:æ™ºèƒ½åŒ…æ¨è'
    )
    
    # å…¨å±€æ ‡å¿—
    flags=(
        '--help:æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯'
        '--version:æ˜¾ç¤ºç‰ˆæœ¬ä¿¡æ¯'
        '--no-color:ç¦ç”¨å½©è‰²è¾“å‡º'
        '--dev:å¯ç”¨å¼€å‘æ¨¡å¼'
    )
    
    # è§£æå½“å‰å‘½ä»¤ä¸Šä¸‹æ–‡
    _arguments -C \
        '1: :->command' \
        '*::arg:->args' \
        '--help[æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯]' \
        '--version[æ˜¾ç¤ºç‰ˆæœ¬ä¿¡æ¯]' \
        '--no-color[ç¦ç”¨å½©è‰²è¾“å‡º]' \
        '--dev[å¯ç”¨å¼€å‘æ¨¡å¼]'
    
    case $state in
        command)
            _describe 'commands' commands
            ;;
        args)
            case $line[1] in
                add)
                    _paker_add_completion
                    ;;
                remove)
                    _paker_remove_completion
                    ;;
                cache)
                    _paker_cache_completion
                    ;;
                rollback)
                    _paker_rollback_completion
                    ;;
                history)
                    _paker_history_completion
                    ;;
                record)
                    _paker_record_completion
                    ;;
                parse)
                    _paker_parse_completion
                    ;;
                io)
                    _paker_io_completion
                    ;;
                remote-add)
                    _paker_remote_add_completion
                    ;;
                remote-rm)
                    _paker_remote_rm_completion
                    ;;
                suggestion)
                    _paker_suggestion_completion
                    ;;
                *)
                    _paker_general_completion
                    ;;
            esac
            ;;
    esac
}

# æ·»åŠ åŒ…è¡¥å…¨
_paker_add_completion() {
    local -a packages common_packages
    
    # ä»ç¼“å­˜è·å–å¯ç”¨åŒ…åˆ—è¡¨
    packages=(${(f)"$(Paker cache list --names-only 2>/dev/null | head -20)"})
    
    # å¸¸ç”¨åŒ…åˆ—è¡¨
    common_packages=(
        'fmt:ç°ä»£C++æ ¼å¼åŒ–åº“'
        'spdlog:å¿«é€ŸC++æ—¥å¿—åº“'
        'nlohmann-json:ç°ä»£C++ JSONåº“'
        'boost:Boost C++åº“é›†åˆ'
        'catch2:ç°ä»£C++æµ‹è¯•æ¡†æ¶'
        'gtest:Googleæµ‹è¯•æ¡†æ¶'
        'benchmark:GoogleåŸºå‡†æµ‹è¯•æ¡†æ¶'
    )
    
    if [[ -n "$packages" ]]; then
        _describe 'packages' packages
    else
        _describe 'common packages' common_packages
    fi
}

# ç§»é™¤åŒ…è¡¥å…¨
_paker_remove_completion() {
    local -a installed_packages
    
    # è·å–å½“å‰é¡¹ç›®å·²å®‰è£…çš„åŒ…
    installed_packages=(${(f)"$(Paker list --names-only 2>/dev/null)"})
    
    if [[ -n "$installed_packages" ]]; then
        _describe 'installed packages' installed_packages
    fi
}

# ç¼“å­˜ç®¡ç†è¡¥å…¨
_paker_cache_completion() {
    local -a cache_commands cache_flags
    
    cache_commands=(
        'add:å®‰è£…åŒ…åˆ°ç¼“å­˜'
        'remove:ä»ç¼“å­˜åˆ é™¤åŒ…'
        'status:æ˜¾ç¤ºç¼“å­˜çŠ¶æ€'
        'clean:æ¸…ç†ç¼“å­˜'
        'lru:LRUç¼“å­˜ç®¡ç†'
    )
    
    cache_flags=(
        '--detailed:æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯'
        '--smart:æ™ºèƒ½æ¸…ç†'
        '--force:å¼ºåˆ¶æ¸…ç†'
        '--stats:æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯'
        '--status:æ˜¾ç¤ºçŠ¶æ€'
    )
    
    _describe 'cache commands' cache_commands
    _describe 'cache flags' cache_flags
}

# å›æ»šè¡¥å…¨
_paker_rollback_completion() {
    local -a rollback_flags installed_packages
    
    rollback_flags=(
        '--previous:å›æ»šåˆ°ä¸Šä¸€ç‰ˆæœ¬'
        '--timestamp:å›æ»šåˆ°æ—¶é—´ç‚¹'
        '--force:å¼ºåˆ¶å›æ»š'
        '--list:åˆ—å‡ºå¯å›æ»šç‰ˆæœ¬'
        '--check:æ£€æŸ¥å›æ»šå®‰å…¨æ€§'
        '--stats:æ˜¾ç¤ºå›æ»šç»Ÿè®¡'
    )
    
    # è·å–å·²å®‰è£…åŒ…åˆ—è¡¨
    installed_packages=(${(f)"$(Paker list --names-only 2>/dev/null)"})
    
    _describe 'rollback flags' rollback_flags
    if [[ -n "$installed_packages" ]]; then
        _describe 'installed packages' installed_packages
    fi
}

# å†å²ç®¡ç†è¡¥å…¨
_paker_history_completion() {
    local -a history_flags installed_packages
    
    history_flags=(
        '--clean:æ¸…ç†å†å²è®°å½•'
        '--export:å¯¼å‡ºå†å²è®°å½•'
        '--import:å¯¼å…¥å†å²è®°å½•'
        '--max-entries:æœ€å¤§æ¡ç›®æ•°'
    )
    
    # è·å–å·²å®‰è£…åŒ…åˆ—è¡¨
    installed_packages=(${(f)"$(Paker list --names-only 2>/dev/null)"})
    
    _describe 'history flags' history_flags
    if [[ -n "$installed_packages" ]]; then
        _describe 'installed packages' installed_packages
    fi
}

# è®°å½•ç®¡ç†è¡¥å…¨
_paker_record_completion() {
    local -a record_flags installed_packages
    
    record_flags=(
        '--list:åˆ—å‡ºæ‰€æœ‰åŒ…è®°å½•'
        '--files:æ˜¾ç¤ºåŒ…æ–‡ä»¶åˆ—è¡¨'
    )
    
    # è·å–å·²å®‰è£…åŒ…åˆ—è¡¨
    installed_packages=(${(f)"$(Paker list --names-only 2>/dev/null)"})
    
    _describe 'record flags' record_flags
    if [[ -n "$installed_packages" ]]; then
        _describe 'installed packages' installed_packages
    fi
}

# è§£æç®¡ç†è¡¥å…¨
_paker_parse_completion() {
    local -a parse_flags
    
    parse_flags=(
        '--stats:æ˜¾ç¤ºè§£æç»Ÿè®¡'
        '--config:æ˜¾ç¤ºè§£æé…ç½®'
        '--clear:æ¸…é™¤è§£æç¼“å­˜'
        '--opt:ä¼˜åŒ–è§£æç¼“å­˜'
        '--validate:éªŒè¯è§£æç¼“å­˜'
    )
    
    _describe 'parse flags' parse_flags
}

# I/Oç®¡ç†è¡¥å…¨
_paker_io_completion() {
    local -a io_flags
    
    io_flags=(
        '--stats:æ˜¾ç¤ºI/Oç»Ÿè®¡'
        '--config:æ˜¾ç¤ºI/Oé…ç½®'
        '--test:è¿è¡ŒI/Oæµ‹è¯•'
        '--bench:è¿è¡ŒI/OåŸºå‡†æµ‹è¯•'
        '--opt:ä¼˜åŒ–I/Oæ€§èƒ½'
    )
    
    _describe 'io flags' io_flags
}

# è¿œç¨‹æºæ·»åŠ è¡¥å…¨
_paker_remote_add_completion() {
    local -a common_remotes git_services
    
    common_remotes=(
        'github:GitHubè¿œç¨‹æº'
        'gitlab:GitLabè¿œç¨‹æº'
        'bitbucket:Bitbucketè¿œç¨‹æº'
        'custom:è‡ªå®šä¹‰è¿œç¨‹æº'
    )
    
    git_services=(
        'github.com:GitHub'
        'gitlab.com:GitLab'
        'bitbucket.org:Bitbucket'
    )
    
    _describe 'common remotes' common_remotes
    _describe 'git services' git_services
}

# è¿œç¨‹æºç§»é™¤è¡¥å…¨
_paker_remote_rm_completion() {
    local -a configured_remotes common_remotes
    
    # è·å–å·²é…ç½®çš„è¿œç¨‹æº
    configured_remotes=(${(f)"$(Paker remote-list --names-only 2>/dev/null)"})
    
    # å¸¸ç”¨è¿œç¨‹æº
    common_remotes=(
        'github:GitHubè¿œç¨‹æº'
        'gitlab:GitLabè¿œç¨‹æº'
        'bitbucket:Bitbucketè¿œç¨‹æº'
    )
    
    if [[ -n "$configured_remotes" ]]; then
        _describe 'configured remotes' configured_remotes
    else
        _describe 'common remotes' common_remotes
    fi
}

# æ™ºèƒ½æ¨èè¡¥å…¨
_paker_suggestion_completion() {
    local -a suggestion_flags categories performance_levels security_levels
    
    suggestion_flags=(
        '--category:æŒ‰ç±»åˆ«è¿‡æ»¤'
        '--performance:æŒ‰æ€§èƒ½è¦æ±‚è¿‡æ»¤'
        '--security:æŒ‰å®‰å…¨è¦æ±‚è¿‡æ»¤'
        '--detailed:æ˜¾ç¤ºè¯¦ç»†åˆ†æ'
        '--auto-install:è‡ªåŠ¨å®‰è£…æ¨èåŒ…'
        '--export:å¯¼å‡ºåˆ†æç»“æœ'
    )
    
    categories=(
        'web:Webåº”ç”¨'
        'desktop:æ¡Œé¢åº”ç”¨'
        'embedded:åµŒå…¥å¼ç³»ç»Ÿ'
        'game:æ¸¸æˆå¼•æ“'
        'scientific:ç§‘å­¦è®¡ç®—'
        'machine_learning:æœºå™¨å­¦ä¹ '
    )
    
    performance_levels=(
        'low:ä½æ€§èƒ½è¦æ±‚'
        'medium:ä¸­ç­‰æ€§èƒ½è¦æ±‚'
        'high:é«˜æ€§èƒ½è¦æ±‚'
    )
    
    security_levels=(
        'low:ä½å®‰å…¨è¦æ±‚'
        'medium:ä¸­ç­‰å®‰å…¨è¦æ±‚'
        'high:é«˜å®‰å…¨è¦æ±‚'
    )
    
    _describe 'suggestion flags' suggestion_flags
    _describe 'categories' categories
    _describe 'performance levels' performance_levels
    _describe 'security levels' security_levels
}

# é€šç”¨è¡¥å…¨
_paker_general_completion() {
    local -a project_commands init_commands
    
    if [[ -f "Paker.json" ]]; then
        # åœ¨Pakeré¡¹ç›®ä¸­
        project_commands=(
            'add:æ·»åŠ ä¾èµ–åŒ…'
            'remove:ç§»é™¤ä¾èµ–åŒ…'
            'list:åˆ—å‡ºæ‰€æœ‰ä¾èµ–'
            'tree:æ˜¾ç¤ºä¾èµ–æ ‘'
            'resolve:è§£æé¡¹ç›®ä¾èµ–'
            'check:æ£€æŸ¥ä¾èµ–å†²çª'
            'fix:è§£å†³ä¾èµ–å†²çª'
            'validate:éªŒè¯ä¾èµ–å®Œæ•´æ€§'
            'suggestion:æ™ºèƒ½åŒ…æ¨è'
        )
        _describe 'project commands' project_commands
    else
        # ä¸åœ¨é¡¹ç›®ä¸­
        init_commands=(
            'init:åˆå§‹åŒ–é¡¹ç›®'
            '--help:æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯'
            '--version:æ˜¾ç¤ºç‰ˆæœ¬ä¿¡æ¯'
        )
        _describe 'init commands' init_commands
    fi
}

# æ™ºèƒ½å»ºè®®åŠŸèƒ½
_paker_smart_suggestions() {
    local cmd="$1"
    local context="$2"
    
    case "$cmd" in
        "add")
            echo "ğŸ’¡ æç¤º: ä½¿ç”¨ 'Paker add <package>' æ·»åŠ ä¾èµ–åŒ…"
            echo "   ç¤ºä¾‹: Paker add fmt spdlog nlohmann-json"
            ;;
        "cache")
            echo "ğŸ’¡ æç¤º: ä½¿ç”¨ 'Paker cache status' æŸ¥çœ‹ç¼“å­˜çŠ¶æ€"
            echo "   ä½¿ç”¨ 'Paker cache clean --smart' æ™ºèƒ½æ¸…ç†ç¼“å­˜"
            ;;
        "rollback")
            echo "ğŸ’¡ æç¤º: ä½¿ç”¨ 'Paker rollback --list <package>' æŸ¥çœ‹å¯å›æ»šç‰ˆæœ¬"
            echo "   ä½¿ç”¨ 'Paker rollback <package> <version>' å›æ»šåˆ°æŒ‡å®šç‰ˆæœ¬"
            ;;
        "perf")
            echo "ğŸ’¡ æç¤º: ä½¿ç”¨ 'Paker perf' ç”Ÿæˆæ€§èƒ½æŠ¥å‘Š"
            echo "   ä½¿ç”¨ 'Paker analyze' åˆ†æä¾èµ–ç»“æ„"
            ;;
    esac
}

# é”™è¯¯å¤„ç†å’Œå»ºè®®
_paker_error_handling() {
    local error_code="$1"
    local command="$2"
    
    case "$error_code" in
        "command_not_found")
            echo "âŒ å‘½ä»¤æœªæ‰¾åˆ°: $command"
            echo "ğŸ’¡ å»ºè®®: ä½¿ç”¨ 'Paker --help' æŸ¥çœ‹å¯ç”¨å‘½ä»¤"
            ;;
        "package_not_found")
            echo "âŒ åŒ…æœªæ‰¾åˆ°: $command"
            echo "ğŸ’¡ å»ºè®®: ä½¿ç”¨ 'Paker search <package>' æœç´¢åŒ…"
            ;;
        "not_in_project")
            echo "âŒ å½“å‰ç›®å½•ä¸æ˜¯Pakeré¡¹ç›®"
            echo "ğŸ’¡ å»ºè®®: ä½¿ç”¨ 'Paker init' åˆå§‹åŒ–é¡¹ç›®"
            ;;
    esac
}

# è‡ªåŠ¨è¡¥å…¨é…ç½®
autoload -U compinit && compinit
autoload -U bashcompinit && bashcompinit

# é™é»˜åŠ è½½ï¼Œä¸æ˜¾ç¤ºæç¤ºä¿¡æ¯
# åªæœ‰åœ¨è°ƒè¯•æ¨¡å¼ä¸‹æ‰æ˜¾ç¤ºåŠ è½½ä¿¡æ¯
if [[ "${PAKER_COMPLETION_DEBUG:-false}" == "true" ]]; then
    echo "âœ… Paker Zsh è¡¥å…¨å·²åŠ è½½"
    echo "ğŸ’¡ ä½¿ç”¨ 'Paker <TAB>' å¼€å§‹æ™ºèƒ½è¡¥å…¨"
fi
